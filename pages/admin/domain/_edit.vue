<template>
     <!-- Ê∑ªÂä†Êàñ‰øÆÊîπÂüüÂêçÂØπËØùÊ°Ü -->
     <el-dialog :title="props.title" v-model="open" width="1000px" append-to-body class="domain-dialog">
      <el-form ref="domainRef" :model="form" :rules="rules" label-width="120px" style="max-height: 600px;">
        <!-- Âü∫Êú¨‰ø°ÊÅØ -->
        <el-divider content-position="left">
          <span style="color: #409eff; font-weight: 600">üìã Âü∫Êú¨‰ø°ÊÅØ</span>
        </el-divider>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="ÂüüÂêç" prop="domainName">
              <el-input v-model="form.domainName" placeholder="ËØ∑ËæìÂÖ•ÂüüÂêç" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="Ê≥®ÂÜåÂïÜ" prop="registrarId">
              <el-select v-model="form.registrarId" placeholder="ËØ∑ÈÄâÊã©Ê≥®ÂÜåÂïÜ" clearable style="width: 100%">
                <el-option v-for="registrar in options.registrars" :key="registrar.id" :label="registrar.name"
                  :value="registrar.id" />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="ÂàõÂª∫Êó∂Èó¥" prop="creationDate">
              <el-date-picker v-model="form.creationDate" type="date" placeholder="ÈÄâÊã©ÂàõÂª∫Êó∂Èó¥" format="YYYY-MM-DD"
                value-format="YYYY-MM-DD" style="width: 100%" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="Âà∞ÊúüÊó∂Èó¥" prop="expiryDate">
              <el-date-picker v-model="form.expiryDate" type="date" placeholder="ÈÄâÊã©Âà∞ÊúüÊó∂Èó¥" format="YYYY-MM-DD"
                value-format="YYYY-MM-DD" style="width: 100%" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="ÂüüÂêçÁä∂ÊÄÅ" prop="domainStatus">
              <el-select v-model="form.domainStatus" placeholder="ËØ∑ÈÄâÊã©ÂüüÂêçÁä∂ÊÄÅ" style="width: 100%">
                <el-option v-for="status in options.domainStatusOptions" :key="status.value" :label="status.label"
                  :value="status.value" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="ÈîÄÂîÆÁä∂ÊÄÅ" prop="salesStatus">
              <el-select v-model="form.salesStatus" placeholder="ËØ∑ÈÄâÊã©ÈîÄÂîÆÁä∂ÊÄÅ" style="width: 100%">
                <el-option v-for="status in options.salesStatusOptions" :key="status.value" :label="status.label"
                  :value="status.value" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="ÂàÜÁ±ª" prop="categoryId">
              <el-select v-model="form.categoryId" placeholder="ËØ∑ÈÄâÊã©ÂàÜÁ±ª" clearable style="width: 100%">
                <el-option v-for="category in options.categories" :key="category.id" :label="category.name"
                  :value="category.id" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="Ê†áÁ≠æ" prop="tagIds">
              <div class="tag-ai-input">
                <el-select v-model="form.tagIds" multiple placeholder="ËØ∑ÈÄâÊã©Ê†áÁ≠æ" style="width: 100%">
                  <el-option v-for="tag in options.tags" :key="tag.id" :label="tag.name" :value="tag.id" />
                </el-select>
                <el-button type="primary" size="small" :icon="aiTagLoading ? 'Loading' : 'MagicStick'"
                  :loading="aiTagLoading" @click="generateAITags" class="ai-btn-tag">
                  AIÊ†áÁ≠æÂª∫ËÆÆ
                </el-button>
              </div>
            </el-form-item>
          </el-col>
        </el-row>

        <!-- ‰ª∑Ê†ºËÆæÁΩÆ -->
        <el-divider content-position="left">
          <span style="color: #67c23a; font-weight: 600">üí∞ ‰ª∑Ê†ºËÆæÁΩÆ</span>
        </el-divider>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="Ë¥≠‰π∞‰ª∑Ê†º" prop="purchasePrice">
              <el-input-number v-model="form.purchasePrice" :precision="2" :min="0" placeholder="ÂüüÂêçË¥≠‰π∞ÊàêÊú¨"
                style="width: 100%" />
            </el-form-item>
          </el-col>

        </el-row>
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="ÈîÄÂîÆ‰ª∑Ê†º" prop="salesPrice">
              <el-input-number v-model="form.salesPrice" :precision="2" :min="0" placeholder="ÂüüÂêçÈîÄÂîÆ‰ª∑Ê†º"
                style="width: 100%" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="‰ª∑Ê†ºÊúâÊïàÊúü" prop="priceExpiry">
              <el-date-picker v-model="form.priceExpiry" type="datetime" placeholder="ÈÄâÊã©‰ª∑Ê†ºÊúâÊïàÊúü"
                format="YYYY-MM-DD HH:mm:ss" value-format="YYYY-MM-DD HH:mm:ss" style="width: 100%" />
            </el-form-item>
          </el-col>

        </el-row>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="ÊäòÊâ£‰ª∑Ê†º" prop="discount">
              <el-input-number v-model="form.discount" :precision="2" :min="0" placeholder="ÊäòÊâ£‰ª∑Ê†º"
                style="width: 100%" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="ÊäòÊâ£ÊúâÊïàÊúü" prop="discountExpiry">
              <el-date-picker v-model="form.discountExpiry" type="datetime" placeholder="ÈÄâÊã©ÊäòÊâ£ÊúâÊïàÊúü"
                format="YYYY-MM-DD HH:mm:ss" value-format="YYYY-MM-DD HH:mm:ss" style="width: 100%" />
            </el-form-item>
          </el-col>
        </el-row>

        <!-- ÂüüÂêçÊèèËø∞ -->
        <el-divider content-position="left">
          <span style="color: #e6a23c; font-weight: 600">üìù ÂüüÂêçÊèèËø∞</span>
        </el-divider>

        <el-form-item label="ÂüüÂêçÂê´‰πâ" prop="domainMeaning">
          <el-input v-model="form.domainMeaning" placeholder="ÁÆÄÁü≠ÊèèËø∞ÂüüÂêçÁöÑÂê´‰πâÔºåÂ¶ÇÔºöÊï∞Â≠ó„ÄÅÂ≠óÊØç„ÄÅË°å‰∏öÁõ∏ÂÖ≥Á≠â" maxlength="100"
            show-word-limit />
        </el-form-item>

        <el-form-item label="ÂüüÂêçÊèèËø∞" prop="domainDescription">
          <div class="description-input">
            <el-input v-model="form.domainDescription" type="textarea" :rows="4" placeholder="ËØ¶ÁªÜÊèèËø∞ÂüüÂêçÁöÑ‰ª∑ÂÄº„ÄÅÁî®ÈÄî„ÄÅÁâπÁÇπÁ≠â"
              maxlength="500" show-word-limit style="width: 100%;" />
            <el-button type="primary" size="small" :icon="aiAnalysisLoading ? 'Loading' : 'MagicStick'"
                :loading="aiAnalysisLoading" @click="generateAIAnalysis" class="ai-btn">
                AIÁîüÊàê
            </el-button>
          </div>
        </el-form-item>
        
        <!-- ÁÇπÂáªË°å‰∏∫ËÆæÁΩÆ -->
        <el-divider content-position="left">
          <span style="color: #409eff; font-weight: 600">üîó ÁÇπÂáªË°å‰∏∫</span>
        </el-divider>
        
        <el-form-item label="ÁÇπÂáªË°å‰∏∫" prop="clickBehavior">
          <el-select v-model="form.clickBehavior" placeholder="ËØ∑ÈÄâÊã©ÂüüÂêçÁÇπÂáªË°å‰∏∫" style="width: 100%">
            <el-option label="Ë∑≥ËΩ¨Âà∞ÁùÄÈôÜÈ°µ" value="landing" />
            <el-option label="ÊòæÁ§∫ËØ¢‰ª∑ÂºπÁ™ó" value="popup" />
            <el-option label="Ë∑≥ËΩ¨Âà∞Â§ñÈÉ®ÈìæÊé•" value="external" />
          </el-select>
        </el-form-item>
        
        <el-form-item v-if="form.clickBehavior === 'external'" label="Â§ñÈÉ®ÈìæÊé•" prop="externalUrl">
          <el-input v-model="form.externalUrl" placeholder="ËØ∑ËæìÂÖ•Â§ñÈÉ®ÈìæÊé•URLÔºå‰æãÂ¶ÇÔºöhttps://example.com" />
        </el-form-item>

        <!-- ÊäÄÊúØ‰ø°ÊÅØ -->
        <el-divider content-position="left">
          <span style="color: #606266; font-weight: 600">‚öôÔ∏è ÊäÄÊúØ‰ø°ÊÅØ</span>
        </el-divider>

        <el-form-item label="ÂüüÂêçÊúçÂä°Âô®" prop="nameServers">
          <el-input v-model="form.nameServers"  placeholder="ËØ∑ËæìÂÖ•ÂüüÂêçÊúçÂä°Âô®ÔºåÂ§ö‰∏™Áî®ÈÄóÂè∑ÂàÜÈöî" />
        </el-form-item>

        <el-form-item label="ÊåÅÊúâ‰∫∫‰ø°ÊÅØ" prop="holderInfo">
          <el-input v-model="form.holderInfo" type="textarea" :rows="3" placeholder="ËØ∑ËæìÂÖ•ÊåÅÊúâ‰∫∫‰ø°ÊÅØ" />
        </el-form-item>

        <!-- Â§áÊ≥®‰ø°ÊÅØ -->
        <el-divider content-position="left">
          <span style="color: #f56c6c; font-weight: 600">üí¨ Â§áÊ≥®‰ø°ÊÅØ</span>
        </el-divider>

        <el-form-item label="Â§áÊ≥®" prop="notes">
          <el-input v-model="form.notes" type="textarea" :rows="3" placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®‰ø°ÊÅØ" />
        </el-form-item>
      </el-form>

      <template #footer>
        <div class="dialog-footer">
          <el-button type="primary" @click="submitForm">Á°Æ ÂÆö</el-button>
          <el-button @click="cancel">Âèñ Ê∂à</el-button>
        </div>
      </template>
    </el-dialog>
    <el-dialog v-model="aiAnalysisDialog" title="AIÂüüÂêçÂàÜÊûêÁªìÊûú" width="600px">
      <el-input type="textarea" :rows="10" v-model="aiAnalysisResult" readonly />
      <template #footer>
        <el-button @click="aiAnalysisDialog = false">ÂÖ≥Èó≠</el-button>
        <el-button type="primary" @click="copyAIAnalysis">Â§çÂà∂ÂàÜÊûêÂÜÖÂÆπ</el-button>
      </template>
    </el-dialog>
</template>

<script setup name="DomainEdit">
import { ElMessage } from 'element-plus'
import { SALES_STATUS_OPTIONS } from '~/utils/constants.js'

// Props
const props = defineProps({
  modelValue: {
    type: Boolean,
    default: false
  },
  title: {
    type: String,
    default: ''
  },
  domainData: {
    type: Object,
    default: null
  },
  options: {
    type: Object,
    default: () => ({})
  }
})

// Emits
const emit = defineEmits(['update:modelValue', 'success'])

// refs
const domainRef = ref()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const open = computed({
  get: () => props.modelValue,
  set: (val) => emit('update:modelValue', val)
})

const aiTagLoading = ref(false)
const aiAnalysisLoading = ref(false)
const aiAnalysisDialog = ref(false)
const aiAnalysisResult = ref('')

// Áõ¥Êé•‰ΩøÁî®‰º†ÂÖ•ÁöÑtitleÂ±ûÊÄß


const data = reactive({
  form: {},
  rules: {
    domainName: [
      { required: true, message: "ÂüüÂêç‰∏çËÉΩ‰∏∫Á©∫", trigger: "blur" },
      {
        min: 1,
        max: 255,
        message: "ÂüüÂêçÈïøÂ∫¶Âú® 1 Âà∞ 255 ‰∏™Â≠óÁ¨¶",
        trigger: "blur",
      },
    ],
    domainStatus: [
      { required: true, message: "ËØ∑ÈÄâÊã©ÂüüÂêçÁä∂ÊÄÅ", trigger: "change" },
    ],
    salesStatus: [
      { required: true, message: "ËØ∑ÈÄâÊã©ÈîÄÂîÆÁä∂ÊÄÅ", trigger: "change" },
    ],
    clickBehavior: [
      { required: false, message: "ËØ∑ÈÄâÊã©ÁÇπÂáªË°å‰∏∫", trigger: "change" },
    ],
    externalUrl: [
      { 
        required: true, 
        message: "Â§ñÈÉ®ÈìæÊé•‰∏çËÉΩ‰∏∫Á©∫", 
        trigger: "blur",
        validator: (rule, value, callback) => {
          if (form.value.clickBehavior === 'external' && !value) {
            callback(new Error('ÈÄâÊã©Â§ñÈÉ®ÈìæÊé•Ë°å‰∏∫Êó∂ÔºåÂ§ñÈÉ®URL‰∏∫ÂøÖÂ°´È°π'));
          } else {
            callback();
          }
        }
      },
      {
        pattern: /^https?:\/\/.+/,
        message: "ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURLÔºå‰ª•http://Êàñhttps://ÂºÄÂ§¥",
        trigger: "blur",
        validator: (rule, value, callback) => {
          if (form.value.clickBehavior === 'external' && value && !/^https?:\/\/.+/.test(value)) {
            callback(new Error('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURLÔºå‰ª•http://Êàñhttps://ÂºÄÂ§¥'));
          } else {
            callback();
          }
        }
      }
    ],
  },
});

const { form, rules } = toRefs(data);

// Ë°®ÂçïÈáçÁΩÆ
function reset() {
  form.value = {
    id: null,
    domainName: null,
    registrarId: null,
    creationDate: null,
    expiryDate: null,
    nameServers: null,
    purchasePrice: null,
    salesPrice: null,
    discount: null,
    discountExpiry: null,
    priceExpiry: null,
    domainMeaning: null,
    domainDescription: null,
    holderInfo: null,
    notes: null,
    domainStatus: 1,
    salesStatus: 1,
    categoryId: null,
    tagIds: [],
    clickBehavior: 'landing',
    externalUrl: null,
  };
  if (domainRef.value) {
    domainRef.value.resetFields();
  }
}

// Êèê‰∫§ÊåâÈíÆ
function submitForm() {
  if (!domainRef.value) return;

  domainRef.value.validate(async (valid) => {
    if (valid) {
      try {
        const response = await $fetch("/api/admin/domains/save", {
          method: "POST",
          body: form.value,
        });

        if (response.code === 200) {
          ElMessage.success(response.message || "Êìç‰ΩúÊàêÂäü");
          open.value = false;
          emit('success');
        } else {
          ElMessage.error(response.message || "Êìç‰ΩúÂ§±Ë¥•");
        }
      } catch (error) {
        console.error("Êìç‰ΩúÂ§±Ë¥•:", error);
        ElMessage.error("Êìç‰ΩúÂ§±Ë¥•");
      }
    }
  });
}

// ÂèñÊ∂àÊåâÈíÆ
function cancel() {
  open.value = false;
  reset();
}

// Ëé∑ÂèñÂüüÂêçÁä∂ÊÄÅÊ†áÁ≠æÁ±ªÂûã
function getDomainStatusType(status) {
  const statusMap = {
    1: "success", // Ê≠£Â∏∏
    2: "danger", // ËøáÊúü
    3: "warning", // ÊöÇÂÅú
    4: "info", // ËΩ¨Âá∫
  };
  return statusMap[status] || "info";
}

// Ëé∑ÂèñÂüüÂêçÁä∂ÊÄÅÊ†áÁ≠æÊñáÊú¨
function getDomainStatusLabel(status) {
  const statusMap = {
    1: "Ê≠£Â∏∏",
    2: "ËøáÊúü",
    3: "ÊöÇÂÅú",
    4: "ËΩ¨Âá∫",
  };
  return statusMap[status] || "Êú™Áü•";
}

// Ëé∑ÂèñÈîÄÂîÆÁä∂ÊÄÅÊ†áÁ≠æÁ±ªÂûã
function getSalesStatusType(status) {
  const statusMap = {
    1: "primary", // ÂæÖÂîÆ
    2: "warning", // Â∑≤‰∏äÊû∂
    3: "success", // Â∑≤ÂîÆÂá∫
    4: "info", // ÊöÇÂÅúÈîÄÂîÆ
  };
  return statusMap[status] || "info";
}

// Ëé∑ÂèñÈîÄÂîÆÁä∂ÊÄÅÊ†áÁ≠æÊñáÊú¨
function getSalesStatusLabel(status) {
  return SALES_STATUS_OPTIONS.find(option => option.value === status)?.label || "Êú™Áü•";
}
 

// AIÁîüÊàêÊ†áÁ≠æÂª∫ËÆÆ
async function generateAITags() {
  if (!form.value.domainName) {
    ElMessage.warning("ËØ∑ÂÖàËæìÂÖ•ÂüüÂêç");
    return;
  }
  aiTagLoading.value = true;
  try {
    // 1. Ëé∑ÂèñAIÊ†áÁ≠æÂª∫ËÆÆ
    const response = await $fetch("/api/admin/ai/adapter/generate", {
      method: "POST",
      body: {
        sceneCode: "domain_tags_suggest",
        input: { domainName: form.value.domainName }
      }
    });
    let tagStr = ''
    if (response.code === 200 && response.data) {
      tagStr = response.data.content || response.data.tags?.map(t => t.name).join(',') || ''
    }
    if (!tagStr) {
      ElMessage.error(response.message || "AIÊ†áÁ≠æÂª∫ËÆÆÂ§±Ë¥•");
      return;
    }
    // 2. ÊâπÈáèÂàõÂª∫/Êü•ÊâæÊ†áÁ≠æ
    const tagSaveRes = await $fetch("/api/admin/tags/save", {
      method: "POST",
      body: { name: tagStr }
    });
    const tagArr = Array.isArray(tagSaveRes.data) ? tagSaveRes.data : [tagSaveRes.data];
    const tagIds = tagArr.map(t => t.id);
    form.value.tagIds = tagIds;
    // 3. Ëá™Âä®Âà∑Êñ∞options.tagsÔºàÂ¶ÇÊúâÊñ∞Ê†áÁ≠æÔºâ
    if (props.options.tags) {
      // ÂêàÂπ∂Êñ∞ËÄÅÊ†áÁ≠æ
      const oldTagIds = props.options.tags.map(t => t.id)
      tagArr.forEach(t => {
        if (!oldTagIds.includes(t.id)) {
          props.options.tags.push(t)
        }
      })
    }
    ElMessage.success("AIÊ†áÁ≠æÂª∫ËÆÆÂ∑≤Â°´ÂÖÖ");
  } catch (error) {
    console.error("AIÊ†áÁ≠æÂª∫ËÆÆÂ§±Ë¥•:", error);
    ElMessage.error("AIÊ†áÁ≠æÂª∫ËÆÆÂ§±Ë¥•");
  } finally {
    aiTagLoading.value = false;
  }
}

// ÁõëÂê¨ÂºπÁ™óÂºÄÂêØÔºåÂàùÂßãÂåñÊï∞ÊçÆ
watch(() => props.modelValue, (newVal) => {
  if (newVal) {
    if (props.domainData) {
      // ÁºñËæëÊ®°Âºè
      form.value = { ...props.domainData };
    } else {
      // Êñ∞Â¢ûÊ®°Âºè
      reset();
    }
  }
})

// ÁªÑ‰ª∂Êö¥Èú≤ÁöÑÊñπÊ≥ïÔºå‰æõÁà∂ÁªÑ‰ª∂Ë∞ÉÁî®
defineExpose({
  reset,
})

async function generateAIAnalysis() {
  if (!form.value.domainName) {
    ElMessage.warning("ËØ∑ÂÖàËæìÂÖ•ÂüüÂêç");
    return;
  }
  aiAnalysisLoading.value = true;
  try {
    const response = await $fetch("/api/admin/ai/adapter/generate", {
      method: "POST",
      body: {
        sceneCode: "domain_analysis",
        input: { domainName: form.value.domainName }
      }
    });
    if (response.code === 200 && response.data && response.data.content) {
      aiAnalysisResult.value = response.data.content
      aiAnalysisDialog.value = true
      ElMessage.success("AIÂüüÂêçÂàÜÊûêÂ∑≤ÁîüÊàê");
    } else {
      ElMessage.error(response.message || "AIÂüüÂêçÂàÜÊûêÂ§±Ë¥•");
    }
  } catch (error) {
    console.error("AIÂüüÂêçÂàÜÊûêÂ§±Ë¥•:", error);
    ElMessage.error("AIÂüüÂêçÂàÜÊûêÂ§±Ë¥•");
  } finally {
    aiAnalysisLoading.value = false;
  }
}

function copyAIAnalysis() {
  if (!aiAnalysisResult.value) return
  navigator.clipboard.writeText(aiAnalysisResult.value)
  ElMessage.success('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø')
}
</script>
<style scoped>
/* ÂüüÂêçÂØπËØùÊ°ÜÊ†∑Âºè */
.domain-dialog .el-dialog__body {
  max-height: 70vh;
  overflow-y: auto;
}

.description-input {
  position: relative;
  width: 100%;
}

.description-input :deep(.el-textarea__inner) {
  padding-right: 80px !important;
}

.ai-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  z-index: 10;
}

.tag-ai-input {
  position: relative;
  width: 100%;
}

.ai-btn-tag {
  position: absolute;
  top: 8px;
  right: 8px;
  z-index: 10;
}

.ai-btn-analysis {
  margin-left: 0;
}
</style>